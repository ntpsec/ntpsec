#!/usr/bin/env python
# coding: utf-8
"""\
ntpviz - logfile visualizer for NTP log files

Usage: ntpviz [-d statsdir] [-g] [-n name] [-p days]
              [-s starttime]  [-e endtime]
              [--local-offset | --local-error | --local-jitter
                | --local-stability | --local-offset-histogram]
              [--peer-offsets=hosts | --all-peer-offsets]
              [--peer-jitters=hosts | --all-peer-jitters]
              [--local-cpu-temp]
              [-o outdir]
              [-D N] [-N]

See the manual page for details.

Python by ESR, concept and GNUPLOT code by Dan Drown.
"""
#SPDX-License-Identifier: BSD-2-Clause
from __future__ import print_function, division

import os, sys, getopt, socket, binascii, collections, time
from ntp.statfiles import *

# RMS frequency jitter - Deviation from a root-mean-square linear approximation?
# Investigate.
#
# TO-DO: Embed Dan Drown's glossary and notes file in the HTML.

def gnuplot(template, outfile=None):
    "Run a specified GNUPLOT program."
    if not len( template ):
        # silently ignore empty plots
        return ''
    if outfile is None:
        out = None
    else:
        out = open(outfile, "w")
    # shell=True is a security hazard
    proc = subprocess.Popen("gnuplot",
                            shell=False, bufsize=4096,
                            stdin=subprocess.PIPE, stdout=out)
    proc.stdin.write(template)
    proc.stdin.close()
    return proc.wait()

def plotwrap(imagename, image, outfile):
    "Generate an image and index section for a GNUPLOT section."
    gnuplot(image, os.path.join(outdir, imagename + ".png"))
    div_name = imagename.replace('-', ' ')
    div = '''\
<div>
  <h3>%s</h3>
  <img src='%s.png' alt='%s plot'>
</div>
''' % (div_name, imagename.replace(':', '%3A'), div_name)
    outfile.write(div)

class NTPViz(NTPStats):
    "Class for visualizing statistics from a single server."
    Common = """\
set terminal png size 900,600
set xdata time
set grid
set xlabel "Time"
set format x "@d-@H:@M"
set timefmt "@s"
set xtic rotate by -45 scale 0
set lmargin 12
set rmargin 12
"""
    def __init__(self, statsdir,
                 sitename=None, period=None, starttime=None, endtime=None):
        NTPStats.__init__(self, statsdir=statsdir, sitename=sitename,
                          period=period, starttime=starttime, endtime=endtime)
        if self.sitename is None:
            self.sitename = os.path.basename(statsdir)
    def local_offset_gnuplot(self):
        "Generate GNUPLOT code graphing local clock loop statistics"
        if not len( self.loopstats):
            sys.stderr.write("ntpviz: WARNING: no loopstats to graph\n")
            return ''
        sitename = self.sitename
        plot_template = NTPViz.Common + """\
set title "%(sitename)s: Local Clock Offset"
set ytics format "@1.2f us" nomirror textcolor rgb '#0060ad'
set y2tics format "@2.3f ppm" nomirror textcolor rgb '#dd181f'
set key bottom right box
set style line 1 lc rgb '#0060ad' lt 1 lw 1 pt 7 ps 0   # --- blue
set style line 2 lc rgb '#dd181f' lt 1 lw 1 pt 5 ps 0   # --- red
plot \
 "-" using 1:($2*1000000) title "clock offset us" with linespoints ls 1, \
 "-" using 1:3 title "frequency offset ppm" with linespoints ls 2 axis x1y2
""" % locals()
        return plot_template.replace('@', '%') + self.dump("loopstats") + "e\n" + self.dump("loopstats")

    def local_cpu_temp_gnuplot(self):
        "Generate GNUPLOT code graphing local cpu temp statistics"
        sitename = self.sitename
        lines = [line + '\n' for line in getattr(self, "cputemp")]
        if not len( lines):
            sys.stderr.write("ntpviz: WARNING: no cputemp to graph\n")
            return ''

        plot_template = NTPViz.Common + """\
set title "%(sitename)s: Local CPU Temp"
set ytics format "@1.1f Â°C" nomirror textcolor rgb '#0060ad'
set style line 1 lc rgb '#0060ad' lt 1 lw 1 pt 7 ps 0   # --- blue
plot \
 "-" using 1:3 title "CPU temp" with linespoints ls 1
""" % locals()
        return plot_template.replace('@', '%')  \
            + "".join(lines)

    def local_error_gnuplot(self):
        "Plot the local clock frequency error."
        if not len( self.loopstats):
            sys.stderr.write("ntpviz: WARNING: no loopstats to graph\n")
            return ''
        sitename = self.sitename
        ninetynine = self.percentile(3, 99, self.loopstats)
        ninetyfive = self.percentile(3, 95, self.loopstats)
        five       = self.percentile(3,  5, self.loopstats)
        one        = self.percentile(3,  1, self.loopstats)
        nf_m_f     = ninetyfive - five
        nn_m_o     = ninetynine - one
        plot_template = NTPViz.Common + """\
set title "%(sitename)s: Local Clock Frequency Offset"
set ytics format "@1.3f ppm" nomirror
set key bottom right box
set style line 1 lc rgb '#0060ad' lt 1 lw 1 pt 7 ps 0   # --- blue
set style line 2 lc rgb '#dd181f' lt 1 lw 1 pt 5 ps 0   # --- red
set label 1 gprintf("99@@ = %(ninetynine)s ppm",99) at graph 0.01,0.3 left front
set label 2 gprintf("95@@ = %(ninetyfive)s ppm",95) at graph 0.01,0.25 left front
set label 3 gprintf(" 5@@ = %(five)s ppm",5) at graph 0.01,0.2 left front
set label 4 gprintf(" 1@@ = %(one)s ppm",1) at graph 0.01,0.15 left front
set label 5 gprintf("95@@ - 5@@ = %(nf_m_f)s ppm",90) at graph 0.01,0.1 left front
set label 6 gprintf("99@@ - 1@@ = %(nn_m_o)s ppm",98) at graph 0.01,0.05 left front
plot \
 "-" using 1:3 title "local clock error" with linespoints ls 2, \
 %(ninetynine)s title "99th percentile", \
 %(ninetyfive)s title "95th percentile", \
 %(five)s title "5th percentile", \
 %(one)s title "1st percentile"
""" % locals()
        return plot_template.replace('@', '%') + self.dump("loopstats")
    def loopstats_gnuplot(self, fld, title, legend):
        "Generate GNUPLOT code of a given loopstats field"
        if not len( self.loopstats):
            sys.stderr.write("ntpviz: WARNING: no loopstats to graph\n")
            return ''
        sitename   = self.sitename
        ninetynine = self.percentile(fld, 99, self.loopstats) * 1000000
        ninetyfive = self.percentile(fld, 95, self.loopstats) * 1000000
        five       = self.percentile(fld,  5, self.loopstats) * 1000000
        one        = self.percentile(fld,  1, self.loopstats) * 1000000
        nf_m_f     = ninetyfive - five
        nn_m_o     = ninetynine - one
        plot_template = NTPViz.Common + """\
set title "%(sitename)s: %(title)s"
set ytics format "@1.2f us" nomirror
set key top right box
set style line 1 lc rgb '#0060ad' lt 1 lw 1 pt 7 ps 0   # --- blue
set style line 2 lc rgb '#dd181f' lt 1 lw 1 pt 5 ps 0   # --- red
set label 1 gprintf("99@@ = %(ninetynine)s us",99) at graph 0.01,0.95 left front
set label 2 gprintf("95@@ = %(ninetyfive)s us",95) at graph 0.01,0.9 left front
set label 3 gprintf(" 5@@ = %(five)s us",5) at graph 0.01,0.85 left front
set label 4 gprintf(" 1@@ = %(one)s us",1) at graph 0.01,0.8 left front
set label 5 gprintf("95@@ - 5@@ = %(nf_m_f)s us",90) at graph 0.01,0.75 left front
set label 6 gprintf("99@@ - 1@@ = %(nn_m_o)s us",98) at graph 0.01,0.7 left front
plot \
 "-" using 1:($%(fld)d*1000000) title "%(legend)s" with linespoints ls 1, \
 %(ninetynine)s title "99th percentile", \
 %(ninetyfive)s title "95th percentile", \
 %(five)s title "5th percentile", \
 %(one)s title "1st percentile"
""" % locals()
        return plot_template.replace('@', '%') + self.dump("loopstats")
    def local_offset_jitter_gnuplot(self):
        "Generate GNUPLOT code of local clock loop standard deviation"
        return self.loopstats_gnuplot(4, "RMS Time jitter", "Jitter")
    def local_offset_stability_gnuplot(self):
        "Generate GNUPLOT code graphing local clock stability"
        return self.loopstats_gnuplot(5, "RMS Frequency Jitter", "Stability")
    def peerstats_gnuplot(self, peerlist, fld, title, type):
        "Plot a specified field from peerstats."
        sitename = self.sitename
        peerdict = self.peersplit()
        if not peerlist:
            peerlist = list(peerdict.keys())
        if not len( peerlist):
            sys.stderr.write("ntpviz: WARNING: no peer data to graph\n")
            return ''
        peerlist.sort() # For stability of output
        peer_data = ()
        plot_data = ""
        labels = ""
        for key in peerlist:
            # Trickiness - we allow peerlist elements to be DNS names.
            # The socket.gethostbyname() call maps DNS names to IP addresses,
            # passing through literal IPv4 addresses unaltered.  However,
            # it barfs on either literal IPv6 addresses or refclock names.
            if "(" in key or "::" in key:
                ip = key
            else:
                ip = socket.gethostbyname(key)
            if ip in peerdict:
                plot_data += "\n".join(peerdict[ip]) + "\ne\n"
            else:
                sys.stderr.write("ntpviz: ERROR: No such peer as %s" % key)
                raise SystemExit(1)
        # remove trailing "e\n"
        plot_data = plot_data[:-2]

        unit = "us"
        multiplier = 1000000
        if len(peerlist) == 1:
            # only one peer
            percentages = ""
            title += ": "+ peerlist[0]
            if "offset" == type:
                ninetynine = self.percentile(4, 99, peerdict[ip]) * 1000000
                ninetyfive = self.percentile(4, 95, peerdict[ip]) * 1000000
                fifty      = self.percentile(4, 50, peerdict[ip]) * 1000000
                five       = self.percentile(4,  5, peerdict[ip]) * 1000000
                one        = self.percentile(4,  1, peerdict[ip]) * 1000000
                if 1000 <= ninetynine:
                    # go to millisec
                    unit = "ms"
                    multiplier = 1000
                    ninetynine /= 1000
                    ninetyfive /= 1000
                    fifty      /= 1000
                    five       /= 1000
                    one        /= 1000

                ninetynine = round( ninetynine, 3)
                ninetyfive = round( ninetyfive, 3)
                fifty      = round( fifty, 3)
                five       = round( five, 3)
                one        = round( one, 3)
                nf_m_f     = ninetyfive - five
                nn_m_o     = ninetynine - one
                percentages = "\n%(fifty)s title '50th percentile', \\" \
                    % locals()
                labels = """\
set label 1 gprintf("99@@ = %(ninetynine)s %(unit)s",99) at graph 0.01,0.95 left front
set label 2 gprintf("95@@ = %(ninetyfive)s %(unit)s",95) at graph 0.01,0.90 left front
set label 3 gprintf("50@@ = %(fifty)s %(unit)s",50) at graph 0.01,0.85 left front
set label 4 gprintf("5@@ = %(five)s %(unit)s",5) at graph 0.01,0.80 left front
set label 5 gprintf("1@@ = %(one)s %(unit)s",1) at graph 0.01,0.75 left front
set label 6 gprintf("95@@ - 5@@ = %(nf_m_f)s %(unit)s",90) at graph 0.01,0.70 left front
set label 7 gprintf("99@@ - 1@@ = %(nn_m_o)s %(unit)s",98) at graph 0.01,0.65 left front
""" % locals()

        else:
            title += "s"
            percentages = ""

        plot_template = NTPViz.Common + """\
set title "%(sitename)s: %(title)s"
set ylabel ""
set ytics format "@1.0f %(unit)s" nomirror
set key top right box
%(labels)s
plot \\%(percentages)s
""" % locals()
        plot_template = plot_template.replace("@", "%")
        for key in peerlist:
            plot_template += "'-' using 1:($%d*%d) title '%s' with line, \\\n" \
                 % (fld, multiplier, self.ip_label(key))


        # strip the trailing ", \\n"
        plot_template = plot_template[:-4] + "\n"
        plot_template += plot_data
        return plot_template
    def peer_offsets_gnuplot(self, peerlist=None):
        return self.peerstats_gnuplot(peerlist, 4, "Peer clock offset", "offset")
    def peer_jitters_gnuplot(self, peerlist=None):
        return self.peerstats_gnuplot(peerlist, 7, "Peer clock jitter", "jitter")
    def peer_rtt_gnuplot(self, host):
        "Plot offset with rtt bounds for specified host."
        sitename = self.sitename
        entries = self.peersplit()[host]
        fifty = self.percentile(4,  50, entries) * 1000000
        host = self.ip_label(host)
        plot_template = NTPViz.Common + """\
set title "%(sitename)s: offset of %(host)s"
set ylabel ""
set ytics format "@1.0f us" nomirror
set key top right box
plot \
'-' using 1:($4*1000000) title 'offset' with line, \
'-' using 1:(($4+$5/2)*1000000) title 'offset+rtt/2' with line, \
'-' using 1:(($4-$5/2)*1000000) title 'offset-rtt/2' with line, \
%(fifty)s title '50th percentile'
""" % locals()
        plot_template = plot_template.replace("@", "%")
        data = "\n".join(entries)
        plot_template += data + "\ne\n" + data + "\ne\n" + data
        return plot_template
    def local_offset_histogram_gnuplot(self):
        "Plot a histogram of clock offset values from loopstats."
        if not len( self.loopstats):
            sys.stderr.write("ntpviz: WARNING: no loopstats to graph\n")
            return ''
        sitename = self.sitename
        cnt = collections.Counter()
        for line in self.loopstats:
            # put into 100 nSec buckets
            cnt[ round( float(line.split()[1]), 7)] += 1
        ninetynine  = self.percentile(2, 99, self.loopstats) * 1000000
        seventyfive = self.percentile(2, 75, self.loopstats) * 1000000
        twentyfive  = self.percentile(2, 25, self.loopstats) * 1000000
        one         = self.percentile(2,  1, self.loopstats) * 1000000
        plot_template = '''\
set terminal png size 900,600
set grid
set xtic rotate by -45 scale 0
set title "%(sitename)s: Local Clock Time Offset - Histogram"
set xtics format "@1.1f us" nomirror
set label 1 gprintf("99@@ = @1.2f us",%(ninetynine)s) at %(ninetynine)s, graph 0.91 left front offset 1,-1
set style arrow 1 nohead
set arrow from %(ninetynine)s,0 to %(ninetynine)s,graph 0.91 as 1
set label 2 gprintf(" 1@@ = @1.2f us",%(one)s) at %(one)s, graph 0.91 right front offset -1,-1
set style arrow 2 nohead
set arrow from %(one)s,0 to %(one)s,graph 0.91 as 2
set label 3 gprintf("25@@ = @1.2f us",%(twentyfive)s) at %(twentyfive)s, graph 0.7 right front offset -1,-1
set style arrow 3 nohead
set arrow from %(twentyfive)s,0 to %(twentyfive)s,graph 0.7 as 3
set label 4 gprintf("75@@ = @1.2f us",%(seventyfive)s) at %(seventyfive)s, graph 0.7 left front offset 1,-1
set style arrow 4 nohead
set arrow from %(seventyfive)s,0 to %(seventyfive)s,graph 0.7 as 4
set key off
set lmargin 12
set rmargin 12
plot \
 "-" using ($1 * 1000000):2 title "histogram" with boxes
''' % locals()
        vals = list(cnt.keys())
        vals.sort()
        histogram_data = ["%s %s\n" % (val, cnt[val]) for val in vals]
        return plot_template.replace('@', '%') + "".join(histogram_data)

ntpsec_logo = """
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
"""

if __name__ == '__main__':
    try:
        (options, arguments) = getopt.getopt(sys.argv[1:], "d:e:ghn:o:p:s:D:N", [
            "local-offset", "local-error", "local-jitter", "local-stability",
            "local-offset-histogram",
            "all-peer-offsets", "peer-offsets=",
            "all-peer-jitters", "peer-jitters=",
            "local-cpu-temp",
            "peer-rtt=",
            ])
    except getopt.GetoptError as err:
        sys.stderr.write(str(err) + "\n")
        raise SystemExit(2)
    sitename = None
    statsdirs = ["/var/log/ntpstats"]
    period = endtime = starttime = None
    generate = False
    show_local_offset = show_local_error = show_local_jitter = False
    show_local_stability = show_local_offset_histogram = show_cpu_temp = False
    show_peer_offsets = show_peer_jitters = None
    show_peer_rtt = None
    outdir = "ntpgraphs"
    debug_level = 0
    nice = 0
    for (switch, val) in options:
        if switch == "-d":
            statsdirs = val.split(",")
        elif switch == "-e":
            endtime = iso_to_posix(val)
        elif switch == "-g":
            generate = True
        elif switch == "-h":
            sys.stdout.write(__doc__)
            raise SystemExit(0)
        elif switch == "-n":
            sitename = val
        elif switch == "-p":
            period = int(val) * NTPStats.SecondsInWeek
        elif switch == "-s":
            starttime = iso_to_posix(val)
        elif switch == "-o":
            outdir = val
        elif switch == "-D":
            debug_level = int(val)      # Debug level, 0 to 9, 9 most verbose
        elif switch == "-N":
            # implemented as integer, in case the option needs to be extended
            nice = 19             # run ntpviz "nice"ly
        elif switch == "--local-offset":
            show_local_offset = True
        elif switch == "--local-error":
            show_local_error = True
        elif switch == "--local-jitter":
            show_local_jitter = True
        elif switch == "--local-stability":
            show_local_stability = True
        elif switch == "--local-offset-histogram":
            show_local_offset_histogram = True
        elif switch == "--peer-offsets":
            show_peer_offsets = val.split(",")
        elif switch == "--all-peer-offsets":
            show_peer_offsets = []
        elif switch == "--peer-jitters":
            show_peer_jitters = val.split(",")
        elif switch == "--all-peer-jitters":
            show_peer_jitters = []
        elif switch == "--peer-rtt":
            show_peer_rtt = val
        elif switch == "--local-cpu-temp":
            show_cpu_temp = True
    if 0 < debug_level:
        sys.stderr.write("ntpviz: INFO: now running at debug: %s\n" % \
            debug_level)
        if 9 == debug_level:
            # crazy debug, also profile
            import cProfile, pstats
            pr = cProfile.Profile()
            pr.enable()

    if 0 != nice:
        try:
            import psutil
            # set ionice() to idle
            p = psutil.Process(os.getpid())
            p.ionice(psutil.IOPRIO_CLASS_IDLE)

        except ImportError:
            if 0 < debug_level:
                sys.stderr.write("ntpviz: INFO: psutils not found\n")
            pass

        # set nice()
        nice = os.nice( nice )
        if 2 < debug_level:
            sys.stderr.write("ntpviz: INFO: now running at nice: %s\n" % \
                nice)

    statlist = [NTPViz(statsdir=d, sitename=sitename,
                       period=period, starttime=starttime, endtime=endtime)
                for d in statsdirs]

    for fontpath in ("/usr/share/fonts/liberation",
                     "/usr/share/fonts/liberation-fonts",
                     "/usr/share/fonts/truetype/liberation"):

        if os.path.exists(fontpath):
            os.environ["GDFONTPATH"] = fontpath
            break
    else:
        sys.stderr.write("ntpviz: WARNING: liberation truetype fonts not found\n")
    os.environ["GNUPLOT_DEFAULT_GDFONT"] = "LiberationSans-Regular"

    if len(statlist) == 1:
        stats = statlist[0]
        if show_local_offset or show_local_error or show_local_jitter or show_local_stability or show_local_offset_histogram:
            if not len( stats.loopstats ):
                sys.stderr.write("ntpviz: ERROR: missing loopstats data\n")
                raise SystemExit(1)
            if show_local_offset + show_local_error + show_local_jitter + show_local_stability + show_local_offset_histogram > 1:
                sys.stderr.write("ntpviz: ERROR: clash of mode options\n")
                raise SystemExit(1)
            if show_local_offset:
                plot = stats.local_offset_gnuplot()
            if show_local_error:
                plot = stats.local_error_gnuplot()
            if show_local_jitter:
                plot = stats.local_offset_jitter_gnuplot()
            if show_local_stability:
                plot = stats.local_offset_stability_gnuplot()
            if show_local_offset_histogram:
                plot = stats.local_offset_histogram_gnuplot()
            if generate:
                gnuplot(plot)
            else:
                sys.stdout.write(plot)
            raise SystemExit(0)

        if show_peer_offsets is not None or show_peer_jitters is not None or show_peer_rtt is not None:
            if not len( stats.peerstats ):
                sys.stderr.write("ntpviz: ERROR:  missing peerstats data\n")
                raise SystemExit(1)
            if show_peer_offsets is not None:
                plot = stats.peer_offsets_gnuplot(show_peer_offsets)
            if show_peer_jitters is not None:
                plot = stats.peer_jitters_gnuplot(show_peer_jitters)
            if show_peer_rtt is not None:
                plot = stats.peer_rtt_gnuplot(show_peer_rtt)
            if generate:
                gnuplot(plot)
            else:
                sys.stdout.write(plot)
            raise SystemExit(0)

        if show_cpu_temp:
            if not len( stats.cputemp):
                sys.stderr.write("ntpviz: ERROR: missing CPU temp data\n")
                raise SystemExit(1)
            if show_cpu_temp is not None:
                plot = stats.local_cpu_temp_gnuplot();
            if generate:
                gnuplot(plot)
            else:
                sys.stdout.write(plot)
            raise SystemExit(0)

    # Fall through to HTML code generation
    if not os.path.isdir(outdir):
        try:
            os.mkdir(outdir)
        except SystemError:
            sys.stderr.write("ntpviz: ERROR: %s can't be created.\n" \
                 % outdir)
            raise SystemExit(1)

    # if no ntpsec logo, write one.
    logo_filename = os.path.join(outdir, "ntpsec-logo.png")
    if not os.path.isfile( logo_filename ):
        with open( logo_filename, "w" ) as wp:
            wp.write(binascii.a2b_base64(ntpsec_logo))

    index_header = '''\
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="refresh" content="1800">
<meta name="expires" content="0">
<title>ntpviz plot</title>
</head>
<body>
<a href='https://www.ntpsec.org/'>
<img src="ntpsec-logo.png" alt="NTPsec" style="float:left;margin:5px 50px;">
</a>
<div>
<h1 style="margin-bottom:10px;">NTP Stats</h1>
'''
    # Ugh.  Not clear what to do in the multiplot case
    if len(statlist) == 1:
        index_header += 'Last Update: %s UTC <br>' % posix_to_iso(stats.starttime)
        index_header += 'Period: %s days <br></div> ' % int(stats.period // NTPStats.SecondsInWeek)
    index_header += '<div style="clear:both;"></div>'

    index_trailer = '''\
<br>
<br>
<br>
<div style="float:left">
This page autogenerated by <a href="https://docs.ntpsec.org/latest/ntpviz.html">
ntpviz</a>, part of the <a href="https://www.ntpsec.org/">NTPsec project</a>
</div>
<div style="float:left;margin-left:350px;">
    <a href="https://validator.w3.org/nu/">
    <img src="https://www.w3.org/html/logo/downloads/HTML5_Logo_32.png" 
        alt="html 5">
    </a>
&nbsp;&nbsp;
    <a href="https://jigsaw.w3.org/css-validator/check/referer">
        <img style="border:0;width:88px;height:31px"
            src="https://jigsaw.w3.org/css-validator/images/vcss"
            alt="Valid CSS!" />
    </a>
</div>
<div style="clear:both;"></div>
</body>
</html>
'''
    with open(os.path.join(outdir, "index.html"), "w") as ifile:
        ifile.write(index_header)
        # if header file, add it to index.html
        header = os.path.join(outdir, "header")
        if os.path.isfile(header):
            try:
                header_file = open( header, 'r')
                header_txt = header_file.read()
                ifile.write('<br>\n' + header_txt + '\n')
            except IOError:
                pass

        if len(statlist) > 1:
            sys.stderr.write("Comparative multiplotting not yet implemented.\n")
        else:
            imagepairs = [
                ("local-offset", stats.local_offset_gnuplot()),
                ("local-error", stats.local_error_gnuplot()),
                ("local-jitter", stats.local_offset_jitter_gnuplot()),
                ("local-stability", stats.local_offset_stability_gnuplot()),
                ("local-offset-histogram", stats.local_offset_histogram_gnuplot()),
                ("peer-offsets", stats.peer_offsets_gnuplot()),
                ("local-cpu-temp", stats.local_cpu_temp_gnuplot()),
                ]
            for key in stats.peersplit().keys():
                imagepairs.append(("peer-offset-" + key,
                               stats.peer_offsets_gnuplot([key])))
            imagepairs.append(("peer-jitters",
                               stats.peer_jitters_gnuplot()))
            for key in stats.peersplit().keys():
                plot = stats.peer_jitters_gnuplot([key])
                if len( plot ):
                    imagepairs.append(("peer-jitter-" + key, plot))

            for (imagename, image) in imagepairs:
                gnuplot(image, os.path.join(outdir, imagename + ".png"))
                for (imagename, _) in imagepairs:
                    div_name = imagename.replace('-', ' ')
                    div = '''\
<div>
  <h3>%s</h3>
  <img src='%s.png' alt='%s plot'>
</div>
''' % (div_name, imagename.replace(':', '%3A'), div_name)
                    ifile.write( div )

        # if footer file, add it to index.html
        footer = os.path.join(outdir, "footer")
        if os.path.isfile(footer):
            try:
                footer_file = open( footer, 'r')
                footer_txt = footer_file.read()
                ifile.write('<br>\n' + footer_txt + '\n')
            except IOError:
                pass
        # and finish the file
        ifile.write(index_trailer)
        ifile.close()


if 9 == debug_level:
    # finish the profile
    pr.disable()
    pr.print_stats('tottime')

# end
