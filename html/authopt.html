<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>

	<head>
		<meta http-equiv="content-type" content="text/html;charset=iso-8859-1">
		<meta name="generator" content="HTML Tidy, see www.w3.org">
		<title>Authentication Options</title>
		<link href="scripts/style.css" type="text/css" rel="stylesheet">
	</head>

	<body>
		<h3>Authentication Options</h3>
		<img src="pic/alice44.gif" alt="gif" align="left"><a href="http://www.eecis.udel.edu/%7emills/pictures.html">from <i>Alice's Adventures in Wonderland</i>, Lewis Carroll</a>
		<p>Our resident cryptographer; now you see him, now you don't.</p>
		<p>Last update: <csobj format="ShortTime" h="25" locale="00000409" region="0" t="DateTime" w="61">02:38</csobj> UTC <csobj format="LongDate" h="25" locale="00000409" region="0" t="DateTime" w="252">Monday, March 17, 2008</csobj></p>
		<br clear="left">
		<h4>Related Links</h4>
		<script type="text/javascript" language="javascript" src="scripts/command.txt"></script>
		<script type="text/javascript" language="javascript" src="scripts/authopt.txt"></script>
		<h4>Table of Contents</h4>
		<ul>
			<li class="inline"><a href="#auth">Introduction</a>
			<li class="inline"><a href="#symm">Symmetric Key Cryptography</a>
			<li class="inline"><a href="#pub">Public Key Cryptography</a>
			<li class="inline"><a href="#group">NTP Secure Groups</a>
			<li class="inline"><a href="#ident">Identity Schemes and Cryptotypes</a>
			<li class="inline"><a href="#cfg">Configuration</a>
			<li class="inline"><a href="#exam">Examples</a>
			<li class="inline"><a href="#cmd">Authentication Commands</a>
			<li class="inline"><a href="#err">Error Codes</a>
			<li class="inline"><a href="#file">Files</a>
		</ul>
		<hr>
		<h4 id="auth">Introduction</h4>
		<p>This page describes the various cryptographic authentication provisions  in NTPv4. Details about the configuration commands and options are given on the <a href="confopt.html">Configuration Options</a> page. Details about the cryptographic authentication schemes are given on the <a href="authopt.html">Authentication Options</a> page. Details about the automatic server discovery schemes are described on the <a href="manyopt.html">Automatic Server Discovery Schemes</a> page. Additional information is available in the papers, reports, memoranda and briefings on the <a href="http://www.eecis.udel.edu/~mills/ntp.html"> NTP Project</a> page.</p>
		<p>Authentication support allows the NTP client to verify that servers are in fact known and trusted and not intruders intending accidentally or intentionally to masquerade as a legitimate server. The NTPv3 specification RFC-1305 defines a scheme using the Data Encryption Standard (DES) algorithm, commonly called DES-CBC. Subsequently, this scheme was replaced by the RSA Message Digest 5 (MD5) algorithm, commonly called keyed-MD5. Either algorithm computes a message digest or one-way hash which can be used to verify the client has the same key as the server.</p>
		<p>NTPv4 includes the NTPv3 scheme, properly described as symmetric key cryptography and, in addition a new scheme based on public key cryptography and called Autokey. Public key cryptography is generally considered more secure than symmetric key cryptography, since the security is based on private and public values which are generated by each participant and where the private value is never revealed. Autokey uses X.509 public certificates, which can be produced by commercial services, utility programs in the OpenSSL software library or a utility program in the NTP software distribution.</p>
		<p>While the algorithms for symmetric key cryptography are included in the NTPv4 software distribution, Autokey cryptography requires the OpenSSL software library to be installed before building the NTP distribution. This library is available from <a href="http://www.openssl.org">http://www.openssl.org</a> and can be installed using the procedures outlined in the <a href="build.html">Building and Installing the Distribution</a> page. Once installed, the configure and build process automatically detects the library and links the library routines required.</p>
		<p>Authentication is configured separately for each association using the <tt>key</tt> or <tt>autokey</tt> option of the <tt>server</tt> command, as described in the <a href="confopt.html">Server Options</a> page, and the options described on this page. The <a href="keygen.html">ntp-keygen</a> page describes the files required for the various authentication schemes. Further details are in the briefings, papers and reports at the NTP project page linked from <a href="http://www.ntp.org">www.ntp.org</a>.</p>
		<h4 id="symm">Symmetric Key Cryptography</h4>
		The original RFC-1305 specification allows any one of possibly 65,534 keys (excluding zero), each distinguished by a 32-bit key ID, to authenticate an association. The servers and clients involved must agree on the key and key ID to authenticate NTP packets. If an NTP packet includes a message authentication code (MAC), consisting of a key ID and message digest, it is accepted only if the key ID matches a trusted key and the message digest is verified with this key. 
		<p>Keys and related information are specified in a keys file, usually called <tt>ntp.keys</tt>, which must be distributed and stored using secure means beyond the scope of the NTP protocol itself. Besides the keys used for ordinary NTP associations, additional keys can be used as passwords for the <tt><a href="ntpq.html">ntpq</a></tt> and <tt><a href="ntpdc.html">ntpdc</a></tt> utility programs. Ordinarily, the <tt>ntp.keys</tt> file is generated by the <tt><a href="keygen.html">ntp-keygen</a></tt> program, but it can be constructed using an ordinary text editor.</p>
		<p>When <tt>ntpd</tt> is first started, it reads the key file specified by the <tt>keys</tt> command and installs the keys in the key cache. However, individual keys must be activated with the <tt>trustedkey</tt> command before use. This allows, for instance, the installation of possibly several batches of keys and then activating a key remotely using <tt>ntpdc</tt>. The <tt>requestkey</tt> command selects the key ID&nbsp;used as the password for the <tt>ntpdc</tt> utility, while the <tt>controlkey</tt> command selects the key ID used as the password for the <tt>ntpq</tt> utility.</p>
		<h4 id="pub">Public Key Cryptography</h4>
		<p>NTPv4 supports the Autokey security protocol, which is based on public key cryptography. The Autokey Version 2 protocol described on the <a href="http://www.eecis.udel.edu/%7emills/proto.html">Autokey Protocol</a> page verifies packet integrity using MD5 message digests and verifies the source using digital signatures and any of several digest/signature schemes. Optional identity schemes described on the <a href="http://www.eecis.udel.edu/%7emills/ident.html">Autokey Identity Schemes</a> page are based on cryptographic challenge/response exchanges. These schemes provide strong security against replay with or without message modification, spoofing, masquerade and most forms of clogging attacks. These schemes are described along with an executive summary, current status, briefing slides and reading list on the <a href="http://www.eecis.udel.edu/%7emills/autokey.html">Autonomous Authentication</a> page.</p>
		<p>Autokey authenticates individual packets using cookies bound to the IP source and destination addresses. The cookies must have the same addresses at both the server and client. For this reason operation with network address translation schemes is not possible. This reflects the intended robust security model where government and corporate NTP   servers are operated outside firewall perimeters.</p>
		<p>There are three timeouts associated with the Autokey scheme. The key list timeout, which defaults to about 1.1 h, specifies the interval between generating new key lists. The revoke timeout, which defaults to about 36 h, specifies the interval between generating new private values. The restart timeout, with default about 5 d, specifies the interval between protocol restarts to refresh public values. In general, the behavior when these timeouts expire is not affected by the issues discussed on this page.</p>
		<h4 id="group">NTP Secure Groups</h4>
		<p>NTP secure groups are used to define cryptographic compartments and security hierarchies. All hosts belonging to a secure group have the same group name but different host names. The string specified in the <tt>host</tt> option of the <tt>crypto</tt> command is the name of the host and the name of the host key, sign key and certificate files. The string specified in the <tt>ident</tt> option of the <tt>crypto</tt> comand is the group name of all group hosts and the name of the identity files. The file naming conventions are described on the <a href="keygen.html">ntp-keygen</a> page.</p>
		<p>Each group includes one or more trusted hosts (THs) operating at the root, or lowest stratum in the group. The group name is used in the subject and issuer fields of the TH&nbsp;trusted certificate. The host name is used in these fields for all other hosts.</p>
		<p>All group hosts are configured to provide an unbroken path, called a certificate trail, from each host, possibly via intermediate hosts and ending at a TH. When a host starts up, it recursively retrieves the certificates along the trail in order to verify group membership and avoid masquerade and middleman attacks.</p>
		<p>Secure groups can be configured as hierarchies where a TH of one group can be a client of one or more other groups operating at a lower stratum. In one scenario, groups RED and GREEN can be cryptographically distinct, but both be clients of group BLUE operating at a lower stratum. In another scenario, group CYAN can be a client of multiple groups YELLOW and MAGENTA, both operating at a lower stratum. There are many other scenarios, but all must be configured to include only acyclic certificate trails.</p>
		<h4 id="ident">Identity Schemes and Cryptotypes</h4>
		<p>All configurations include a public/private host key pair and matching certificate. Absent an identity scheme, this is a Trusted Certificate (TC) scheme. There are three identity schemes, IFF, GQ and MV described on the <a href="http://www.eecis.udel.edu/%7emills/ident.html">Identity Schemes</a> page. With these schemes all servers in the group have encrypted server identity keys, while clients have nonencrypted client identity parameters. The client parameters can be obtained from a trusted agent (TA), usually one of the THs of the lower stratum group. Further information on identity schemes is on the <a href="http://www.eecis.udel.edu/%7emills/ident.html">Autokey Identity Schemes</a> page.</p>
		<p>A specific combination of authentication and identity schemes is called a cryptotype, which applies to clients and servers separately. A group can be configured using more than one cryptotype combination, although not all combinations are interoperable. Note however that some cryptotype combinations may successfully interoperate with each other, but may not represent good security practice. The server and client cryptotypes are defined by the the following codes.</p>
		<dl>
			<dt>NONE
			<dd>A client or server is type NONE if authentication is not available or not configured. Packets exchanged between client and server have no MAC.
			<dt>AUTH
			<dd>A client or server is type AUTH&nbsp;if the <tt>key</tt> option is specified with the <tt>server</tt> configuration command and the client and server keys are compatible. Packets exchanged between clients and servers have a MAC.<dt>PC
			<dd>A client or server is type PC if the <tt>autokey</tt> option is specified with the <tt>server</tt> configuration command and compatible host key and private certificate files are present. Packets exchanged between clients and servers have a MAC.<dt>TC
			<dd>A client or server is type TC  if the <tt>autokey</tt> option is specified with the <tt>server</tt> configuration command and compatible host key and public certificate files are present. Packets exchanged between clients and servers have a MAC.<dt>IDENT
			<dd>A client or server is type IDENT  if the <tt>autokey</tt> option is specified with the <tt>server</tt> configuration command and compatible host key, public certificate and identity scheme files are present. Packets exchanged between clients and servers have a MAC.</dl>
		<p>The compatible cryptotypes for clients and servers are listed in the following table.</p>
		<table width="100%" border="1" cellpadding="4">
			<tr>
				<td rowspan="2" align="center">Client</td>
				<td colspan="5" align="center">Server</td>
			</tr>
			<tr>
				<td align="center">NONE</td>
				<td align="center">AUTH</td>
				<td align="center">PC</td>
				<td align="center">TC</td>
				<td align="center">IDENT</td>
			</tr>
			<tr>
				<td align="center">NONE</td>
				<td align="center">yes</td>
				<td align="center">yes*</td>
				<td align="center">yes*</td>
				<td align="center">yes*</td>
				<td align="center">yes*</td>
			</tr>
			<tr>
				<td align="center">AUTH</td>
				<td align="center">no</td>
				<td align="center">yes</td>
				<td align="center">no</td>
				<td align="center">no</td>
				<td align="center">no</td>
			</tr>
			<tr>
				<td align="center">PC</td>
				<td align="center">no</td>
				<td align="center">no</td>
				<td align="center">yes</td>
				<td align="center">no</td>
				<td align="center">no</td>
			</tr>
			<tr>
				<td align="center">TC</td>
				<td align="center">no</td>
				<td align="center">no</td>
				<td align="center">no</td>
				<td align="center">yes</td>
				<td align="center">yes</td>
			</tr>
			<tr>
				<td align="center">IDENT</td>
				<td align="center">no</td>
				<td align="center">no</td>
				<td align="center">no</td>
				<td align="center">no</td>
				<td align="center">yes</td>
			</tr>
		</table>
		<p>* These combinations are not valid if the restriction list includes the <tt>notrust</tt> option.</p>
		<h4 id="cfg">Configuration</h4>
		<p>Autokey has an intimidating number of configuration options, most of which are not necessary in typical scenarios. The simplest scenario consists of an unnamed secure group with one TH at the lowest stratum. For the simplest identity scheme TC, the TH generates host key and trusted certificate files using the <tt>ntp-keygen -T</tt> command, while the remaining group hosts use the same command with no options to generate the host key and public certificate files. All hosts use the <tt>crypto</tt> configuration command with no options. Configuration with passwords is described in the <a href="keygen.html">ntp-keygen</a> page</p>
		<p>When an identity scheme is included, for example IFF, the TH generates host key, trusted certificate and private server identity files using the <tt>ntp-keygen -T -I -i <i>group</i> </tt>command, where <tt><i>group</i></tt> is the group name. The reemaining group hosts use the same command as above. The client identity files are obtained separately. All  hosts use the <tt>crypto ident&nbsp;<i>group</i></tt> configuration command.</p>
		<p>Hosts with no dependent clients can retrieve client files from an archive or web page. The <tt>ntp-keygen</tt>&nbsp;can export these data using the <tt>-e</tt> option. Hosts with dependent clients other than the TH must retrieve copies of the server files using secure means. The <tt>ntp-keygen</tt>&nbsp;can export these data using the <tt>-q</tt> option. In either case the data are installed as a file and then renamed using the name given as the first line in the file, but without the filestamp.</p>
		<h4 id="exam">Examples</h4>
		<p>Consider a scenario involving three secure groups RED, GREEN and BLUE. RED and BLUE are typical of national laboratories providing certified time to the Internet at large. TH&nbsp;mort of RED&nbsp;and TH&nbsp;macabre of BLUE run NTP&nbsp;symmetric mode with each other for monitoring or backup. GREEN is typical of a large university providing certified time to the campus community. TH&nbsp;howland of GREEN is a client of both RED and BLUE. BLUE uses the IFF scheme, while both RED and GREEN use the GQ scheme, but with different keys.</p>
		<p>BLUE&nbsp;TH&nbsp;macabre uses configuration commands</p>
		<p><tt>crypto pw qqsv ident blue<br>
		peer mort autokey</tt></p>
		<p>where <tt>qqsv</tt> is the password for macabre files. It generates BLUE files using the commands</p>
		<p><tt>ntp-keygen -p qqsv -T -G -i blue<br>
				ntp-keygen -p qqsv -e &gt;ntpkey_gqpar_blue</tt></p>
		<p>The first line generates the host, trusted certificate and private GQ server files. The second generates the public GQ client file, which can have any nonconflicting mnemonic name.</p>
		<p>RED&nbsp;TH&nbsp;mort uses configuration commands</p>
		<p><tt>crypto pw xxx ident red<br>
				peer macabre autokey</tt></p>
		<p>where <tt>xxx</tt> is the password for mort files. It generates RED&nbsp;files using the commands</p>
		<p><tt>ntp-keygen -p xxx -T -I -i red<br>
				ntp-keygen -p xxx -e &gt;ntpkey_iffpar_red</tt></p>
		<p>GREEN TH&nbsp;howland uses configuration commands</p>
		<p><tt>crypto pw yyy ident green<br>
			</tt><tt>server mort autokey<br>
			</tt><tt>server macabre autokey</tt></p>
		<p>where <tt>yyy</tt> is the password for howland files. It generates GREEN files using the commands</p>
		<p><tt>ntp-keygen -p yyy -T -G -i green<br>
				ntp-keygen -p yyy -e &gt;ntpkey_gqpar_green<br>
			</tt><tt>ntp-keygen -p yyy -q zzz &gt;zzz_ntpkey_gqkey_green</tt></p>
		<p>The first two lines serve the same purpose as the preceeding examples. The third line generats a copy of the private GREEN&nbsp;server file for use on another server in the same group, but encrypted with the <tt>zzz</tt> pasword.</p>
		<p>A client of GREEN, for example, uses the configuration commands</p>
		<p><tt>crypto pw abc ident green<br>
			</tt><tt>server howland autokey</tt></p>
		<p>where <tt>abc</tt> is the password for its files. It generates files using the command</p>
		<p><tt>ntp-keygen -p abc</tt></p>
		<p>The client retrieves the client file for that group from a public archive or web page using nonsecure means. In addition, each server in a group retrieves the private server file from the TH&nbsp;of that group, but it is encrypted and so can be sent using nonsecured means. The files are installed in the keys directory with name taken from the first line in the file, but without the filestamp.</p>
		<p>In another example mort and macabre are operated as broadcast servers and howland as a broadcast client. Replace the server configuration command for both mort and macabre with the two commands</p>
		<p><tt>broadcast <i>ipaddr</i> autokey<br>
				broadcastclient</tt></p>
		<p>where <tt><i>ipaddr</i></tt> is the broadast address, and replace the two server commands for howland with the single command</p>
		<p><tt>broadcastclient</tt></p>
		<p>Note that if servers of different groups, in this case RED and BLUE, share the same broadcast media, each server must have client files for all groups other than its own, while each client must have client files for all groups.</p>
		<h4 id="cmd">Authentication Commands</h4>
		<dl>
			<dt id=autokey><tt>autokey [<i>logsec</i>]</tt>
			<dd>Specifies the interval between regenerations of the session key list used with the Autokey protocol, as a power of 2 in seconds. Note that the size of the key list for each association depends on this interval and the current poll interval. The default interval is 12 (about 1.1 h). For poll intervals above the specified interval, a session key list with a single entry will be regenerated for every message sent.<dt id="controlkey"><tt>controlkey <i>key</i></tt>
			<dd>Specifies the key ID to use with the <a href="ntpq.html"><tt>ntpq</tt></a> utility, which uses the standard protocol defined in RFC-1305. The <tt><i>key</i></tt> argument is the key ID for a trusted key, where the value can be in the range 1 to 65,534, inclusive.
			<dt id="crypto"><tt>crypto [randfile <i>file</i>] [host <i>name</i>] [ident <i>name</i>] [pw <i>password</i>]</tt>
			<dd>This command requires the OpenSSL library. It activates public key cryptography and loads the required host key and public certificat. If one or more files are left unspecified, the default names are used as described below. Unless the complete path and name of the file are specified, the location of a file is relative to the keys directory specified in the <tt>keysdir</tt> configuration command or default <tt>/usr/local/etc</tt>. Following are the options.
			<dl>
					<dt><tt>host <i>name</i></tt>
					<dd>Specifies the string used when constructing the names for the host, sign and certificate files generated by the <tt>ntp-keygen</tt> program  with the <tt>-s <i>name</i></tt> option.
					<dt><tt>ident <i>name</i></tt>
					<dd>Specifies the string used in constructing the identity files generated by the <tt>ntp-keygen </tt>program with the <tt>-i <i>name</i></tt> option.<dt><tt>pw <i>password</i></tt>
					<dd>Specifies the password to decrypt files previously encrypted by the <tt>ntp-keygen</tt> program with the <tt>-p</tt> option.
					<dt><tt>randfile <i>file</i></tt>
					<dd>Specifies the location of the random seed file used by the OpenSSL library. The defaults are described on the <a href="keygen.html"><tt>ntp-keygen</tt></a> page.
				</dl>
			<dt id="keys"><tt>keys <i>keyfile</i></tt>
			<dd>Specifies the complete path to the MD5 key file containing the keys and key IDs used by <tt>ntpd</tt>, <tt>ntpq</tt> and <tt>ntpdc</tt> when operating with symmetric key cryptography. This is the same operation as the <tt>-k </tt>command line option.
			<dt id="keysdir"><tt>keysdir <i>path</i></tt>
			<dd>This command specifies the default directory path for cryptographic keys, parameters and certificates. The default is <tt>/usr/local/etc/</tt>.
			<dt id="requestkey"><tt>requestkey <i>key</i></tt>
			<dd>Specifies the key ID to use with the <a href="ntpdc.html"><tt>ntpdc</tt></a> utility program, which uses a proprietary protocol specific to this implementation of <tt>ntpd</tt>. The <tt><i>key</i></tt> argument is a key ID for the trusted key, where the value can be in the range 1 to 65,534, inclusive.<dt id="revoke"><tt>revoke [<i>logsec</i>]</tt>
			<dd>Specifies the interval between re-randomization of certain cryptographic values used by the Autokey scheme, as a power of 2 in seconds. These values need to be updated frequently in order to deflect brute-force attacks on the algorithms; however, updating some values is a relatively expensive operation. The default interval is 17 (about 36 h). For poll intervals above the specified interval, the values will be updated for every message sent.<dt id="trustedkey"><tt>trustedkey <i>key</i> [...]</tt>
			<dd>Specifies the key ID which are trusted for the purposes of authenticating peers with symmetric key cryptography, as well as keys used by the <tt>ntpq</tt> and <tt>ntpdc</tt> programs. The authentication procedures require that both the local and remote servers share the same key and key ID for this purpose, although different keys can be used with different servers.</dl>
		<h4 id="err">Error Codes</h4>
		<p>Errors can occur due to mismatched configurations, unexpected restarts, expired certificates and unfriendly people. In most cases the protocol state machine recovers automatically by retransmission, timeout and restart, where necessary. Some errors are due to mismatched keys, digest schemes or identity schemes and must be corrected by installing the correct media and/or correcting the configuration file. One of the most common errors is expired certificates, which must be regenerated and signed at least once per year using the <tt><a href="keygen.html">ntp-keygen</a></tt> program.</p>
		<p>The following error codes are reported via the NTP control and monitoring protocol trap mechanism.</p>
		<dl>
			<dt>101 (bad field format or length)
			<dd>The packet has invalid version, length or format.
			<dt>102 (bad timestamp)
			<dd>The packet timestamp is the same or older than the most recent received. This could be due to a replay or a server clock time step.
			<dt>103 (bad filestamp)
			<dd>The packet filestamp is the same or older than the most recent received. This could be due to a replay or a key file generation error.
			<dt>104 (bad or missing public key)
			<dd>The public key is missing, has incorrect format or is an unsupported type.
			<dt>105 (unsupported digest type)
			<dd>The server requires an unsupported digest/signature scheme.
			<dt>106 (unsupported identity type)<dd>The client or server has requested an identity scheme the other does not support.<dt>107 (bad signature length)
			<dd>The signature length does not match the current public key.
			<dt>108 (signature not verified)
			<dd>The message fails the signature check. It could be bogus or signed by a different private key.
			<dt>109 (certificate not verified)
			<dd>The certificate is invalid or signed with the wrong key.<dt>110 (host certificate expired)<dd>The old server certificate has expired.<dt>111 (bad or missing cookie)
			<dd>The cookie is missing, corrupted or bogus.
			<dt>112 (bad or missing leapseconds table)
			<dd>The leapseconds table is missing, corrupted or bogus.
			<dt>113 (bad or missing certificate)
			<dd>The certificate is missing, corrupted or bogus.
			<dt>114 (bad or missing group key)
			<dd>The identity key is missing, corrupt or bogus.
			<dt>115 (protocol error)
			<dd>The protocol state machine has wedged due to unexpected restart
			<dt>116 (server certificate expired)
			<dd>The old server certificate has expired.
		</dl>
		<h4 id="file">Files</h4>
		<p>See the <a href="keygen.html"><tt>ntp-keygen</tt></a> page. Note that provisions to load leap second values from the NIST files have been removed. These provisions are now available whether or not the OpenSSL library is available. However, the functions that can download these values from servers remains available.</p>
		<hr>
		<script type="text/javascript" language="javascript" src="scripts/footer.txt"></script>
	</body>

</html>