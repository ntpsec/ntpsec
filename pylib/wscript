from waflib import Utils  # pylint: disable=import-error
from wafhelpers.fix_python_config import FixConfig


def options(opt):
    opt.load('python')


def configure(conf):
    fixed = FixConfig(conf)
    fixed.load('python')
    fixed.check_python_version((2, 6, 0))
    conf.check_python_headers(features='pyext')  # Extension-only, no embedded
    # Library directory hack 1
    # For unknown reasons python libs are getting shunted off where they
    # should not be on gentoo.
    if conf.env.PYTHONDIR.startswith(conf.env.PREFIX) is False:
        splitPoint = conf.env.PYTHONDIR.find("/python")
        tail = conf.env.PYTHONDIR[splitPoint:]
        conf.env.PYTHONDIR = conf.env.PREFIX + "lib" + tail
    if conf.env.PYTHONARCHDIR.startswith(conf.env.PREFIX) is False:
        splitPoint = conf.env.PYTHONARCHDIR.find("/python")
        tail = conf.env.PYTHONARCHDIR[splitPoint:]
        conf.env.PYTHONARCHDIR = conf.env.PREFIX + "lib" + tail
    # Library directory hack 2, dist-packages is what python reports.
    # That is reserved by the FHS, we have to use site-packages for user
    # installs. Distribution installs can use dist-packages.
    if "/usr/local/" in conf.env.PYTHONDIR:
        if "dist-packages" in conf.env.PYTHONDIR:
            conf.env.PYTHONDIR = conf.env.PYTHONDIR.replace("dist", "site")
        if "dist-packages" in conf.env.PYTHONARCHDIR:
            conf.env.PYTHONARCHDIR = conf.env.PYTHONARCHDIR.replace("dist", "site")


def build(ctx):
    srcnode = ctx.srcnode.make_node('pylib')
    bldnode = ctx.bldnode.make_node('pylib')
    target1 = bldnode.make_node('control.py')
    target2 = bldnode.make_node('magic.py')
    target3 = bldnode.make_node('version.py')
    target4 = ctx.srcnode.make_node('wafhelpers/.autorevision-cache')
    sources = srcnode.ant_glob('*.py')
    builds = [x.get_bld() for x in sources]

    # Make sure Python sees .py as well as .pyc/.pyo
    ctx(
        features="subst",
        source=sources,
        target=builds,
    )

    ctx(
        before=['pyc', 'pyo'],
        cwd=srcnode,
        rule='${SRC} >${TGT}',
        source=["../wafhelpers/pythonize-header", "../include/ntp_control.h"],
        target=target1,
    )

    ctx(
        before=['pyc', 'pyo'],
        cwd=srcnode,
        rule='${SRC} >${TGT}',
        source=["../wafhelpers/pythonize-header", "../include/ntp.h"],
        target=target2,
    )

    ctx(
        before=['pyc', 'pyo'],
        cwd=srcnode,
        rule='VCS_EXTRA=`cat ${SRC[0]}` ../wafhelpers/autorevision.sh '
             '-o ${TGT[1].abspath()} -e VERSION -t python >${TGT[0].abspath()}',
        source=["../VERSION", '../wafhelpers/autorevision.sh'],
        target=[target3, target4],
    )

    # Force early creation of generated files
    ctx.add_group()

    ctx(
        features='py',
        source=builds+[target1, target2, target3],
        install_from=bldnode,
        install_path='${PYTHONDIR}/ntp'
    )
